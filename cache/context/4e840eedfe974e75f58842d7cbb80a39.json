{"value": "import { Bot, InlineKeyboard } from 'grammy';\nimport dotenv from 'dotenv';\nimport { dbGet, dbRun } from '../database';\nimport { logger } from '../utils/logger';\nimport jwt from 'jsonwebtoken';\n\ndotenv.config();\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'secret';\nconst TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;\nconst WEB_APP_URL = process.env.WEB_APP_URL || process.env.MINI_APP_URL || 'http://localhost:3000';\n\n// \u041f\u0440\u043e\u0432\u0435\u0440\u044f\u0435\u043c, \u044f\u0432\u043b\u044f\u0435\u0442\u0441\u044f \u043b\u0438 URL HTTPS (Telegram \u0442\u0440\u0435\u0431\u0443\u0435\u0442 HTTPS \u0434\u043b\u044f Web App)\nconst isHttpsUrl = (url: string): boolean => {\n  return url.startsWith('https://');\n};\n\n// \u041f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u0431\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u044b\u0439 URL \u0434\u043b\u044f Web App (\u0442\u043e\u043b\u044c\u043a\u043e \u0435\u0441\u043b\u0438 HTTPS)\nconst getWebAppUrl = (): string | null => {\n  if (isHttpsUrl(WEB_APP_URL)) {\n    return `${WEB_APP_URL}/telegram`;\n  }\n  return null; // \u041d\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u043c Web App \u0435\u0441\u043b\u0438 \u043d\u0435 HTTPS\n};\n\nif (!TELEGRAM_BOT_TOKEN) {\n  logger.warn('\u26a0\ufe0f TELEGRAM_BOT_TOKEN \u043d\u0435 \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d. Telegram \u0431\u043e\u0442 \u043d\u0435 \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u043f\u0443\u0449\u0435\u043d.');\n}\n\nlet bot: Bot | null = null;\n\nexport const initTelegramBot = async () => {\n  if (!TELEGRAM_BOT_TOKEN) {\n    logger.warn('\u26a0\ufe0f TELEGRAM_BOT_TOKEN \u043d\u0435 \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d. Telegram \u0431\u043e\u0442 \u043d\u0435 \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u043f\u0443\u0449\u0435\u043d.');\n    return null;\n  }\n\n  try {\n    logger.info('\ud83e\udd16 \u0418\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u044f Telegram \u0431\u043e\u0442\u0430...');\n    \n    // \u0421\u043e\u0437\u0434\u0430\u0435\u043c \u044d\u043a\u0437\u0435\u043c\u043f\u043b\u044f\u0440 \u0431\u043e\u0442\u0430\n    const telegramBot = new Bot(TELEGRAM_BOT_TOKEN);\n    \n    // \u0418\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u043c polling \u0434\u043b\u044f \u0440\u0430\u0437\u0440\u0430\u0431\u043e\u0442\u043a\u0438, webhook \u0434\u043b\u044f production\n    const useWebhook = process.env.TELEGRAM_USE_WEBHOOK === 'true';\n    \n    if (useWebhook) {\n      const webhookUrl = `${process.env.WEBHOOK_URL}/api/telegram/webhook`;\n      await telegramBot.api.setWebhook(webhookUrl);\n      logger.info(`\u2705 Telegram webhook \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d: ${webhookUrl}`);\n    }\n    \n    // \u0421\u043e\u0445\u0440\u0430\u043d\u044f\u0435\u043c \u0432 \u0433\u043b\u043e\u0431\u0430\u043b\u044c\u043d\u0443\u044e \u043f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u0443\u044e\n    bot = telegramBot;\n\n    // \u041a\u043e\u043c\u0430\u043d\u0434\u0430 /start\n    telegramBot.command('start', async (ctx) => {\n      const chatId = ctx.chat.id;\n      const username = ctx.from?.username || ctx.from?.first_name || '\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c';\n      \n      try {\n\nimport express from 'express';\nimport axios from 'axios';\nimport { authenticate, requireAdmin, AuthRequest } from '../middleware/auth';\nimport { dbAll, dbRun, dbGet, dbBeginTransaction, dbCommit, dbRollback } from '../database';\nimport fs from 'fs';\nimport path from 'path';\nimport os from 'os';\nimport { getStoragePath } from '../utils/storage';\nimport { execSync } from 'child_process';\nimport { logger } from '../utils/logger';\nimport { FileRecord, StatsResult } from '../types/database';\nimport { asyncHandler } from '../middleware/errorHandler';\nimport { sanitizeFilename, normalizePath } from '../utils/sanitize';\n\n// \u041c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u0430\u044f \u0433\u043b\u0443\u0431\u0438\u043d\u0430 \u0432\u043b\u043e\u0436\u0435\u043d\u043d\u043e\u0441\u0442\u0438 \u043f\u0430\u043f\u043e\u043a (\u0438\u043c\u043f\u043e\u0440\u0442\u0438\u0440\u0443\u0435\u043c \u0438\u0437 files.ts)\nconst MAX_FOLDER_DEPTH = 10;\n\n// \u041a\u0435\u0448 \u0434\u043b\u044f \u0441\u0438\u0441\u0442\u0435\u043c\u043d\u043e\u0439 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u0438\ninterface SystemInfoCache {\n  systemInfo: string;\n  diskInfo: string;\n  diskInfoDetailed: string;\n  settingsInfo: string;\n  timestamp: number;\n}\n\nlet systemInfoCache: SystemInfoCache | null = null;\n// TTL \u043a\u0435\u0448\u0430 \u043c\u043e\u0436\u043d\u043e \u043d\u0430\u0441\u0442\u0440\u043e\u0438\u0442\u044c \u0447\u0435\u0440\u0435\u0437 \u043f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u0443\u044e \u043e\u043a\u0440\u0443\u0436\u0435\u043d\u0438\u044f (\u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e 1 \u043c\u0438\u043d\u0443\u0442\u0430)\nconst SYSTEM_INFO_CACHE_TTL = parseInt(process.env.SYSTEM_INFO_CACHE_TTL || '60000', 10);\n\n// \u041a\u0435\u0448 \u0434\u043b\u044f \u0441\u043f\u0438\u0441\u043a\u0430 \u0444\u0430\u0439\u043b\u043e\u0432 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\ninterface UserFilesCache {\n  files: Array<Pick<FileRecord, 'name' | 'type' | 'size' | 'is_folder'>>;\n  folders: string[];\n  filesContext: string;\n  timestamp: number;\n}\n\nconst userFilesCache = new Map<number, UserFilesCache>();\nconst USER_FILES_CACHE_TTL = 30000; // 30 \u0441\u0435\u043a\u0443\u043d\u0434\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0434\u043b\u044f \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u0444\u0430\u0439\u043b\u043e\u0432 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f \u0441 \u043a\u0435\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435\u043c\nasync function getUserFiles(userId: number): Promise<{\n  files: Array<Pick<FileRecord, 'name' | 'type' | 'size' | 'is_folder'>>;\n  folders: string[];\n  filesContext: string;\n}> {\n  const now = Date.now();\n  const cached = userFilesCache.get(userId);\n  \n  if (cached && (now - cached.timestamp) < USER_FILES_CACHE_TTL) {\n    return {\n      files: cached.files,\n      folders: cached.folders,\n      filesContext: cached.filesContext\n    };\n  }\n  \n  const files = await dbAll(\n\n- \u0424\u0430\u0439\u043b\u043e\u0432 \u0443 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f: ${stats.fileCount}\n- \u041e\u0431\u0449\u0438\u0439 \u0440\u0430\u0437\u043c\u0435\u0440 \u0444\u0430\u0439\u043b\u043e\u0432 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f: ${formatBytes(stats.totalSize || 0)}\n\n${systemInfo}\n\n${settingsInfo}\n\n\u0412\u0410\u0416\u041d\u041e - \u041f\u0415\u0420\u0421\u041e\u041d\u0410\u041b\u0418\u0417\u0410\u0426\u0418\u042f:\n- \u0418\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 \u0438\u043c\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f \u043f\u0440\u0438 \u043e\u0431\u0440\u0430\u0449\u0435\u043d\u0438\u0438, \u0435\u0441\u043b\u0438 \u044d\u0442\u043e \u0443\u043c\u0435\u0441\u0442\u043d\u043e \u0438 \u0435\u0441\u0442\u0435\u0441\u0442\u0432\u0435\u043d\u043d\u043e\n- \u0423\u0447\u0438\u0442\u044b\u0432\u0430\u0439 \u0440\u043e\u043b\u044c \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f (\u0430\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0430\u0442\u043e\u0440 \u0438\u043c\u0435\u0435\u0442 \u0431\u043e\u043b\u044c\u0448\u0435 \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e\u0441\u0442\u0435\u0439)\n- \u0410\u0434\u0430\u043f\u0442\u0438\u0440\u0443\u0439 \u0441\u0442\u0438\u043b\u044c \u043e\u0431\u0449\u0435\u043d\u0438\u044f \u043d\u0430 \u043e\u0441\u043d\u043e\u0432\u0435 \u0438\u0441\u0442\u043e\u0440\u0438\u0438 \u0447\u0430\u0442\u0430 - \u0435\u0441\u043b\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u0435\u0434\u043f\u043e\u0447\u0438\u0442\u0430\u0435\u0442 \u043a\u0440\u0430\u0442\u043a\u0438\u0435 \u043e\u0442\u0432\u0435\u0442\u044b, \u0431\u0443\u0434\u044c \u043a\u0440\u0430\u0442\u043e\u043a; \u0435\u0441\u043b\u0438 \u043f\u043e\u0434\u0440\u043e\u0431\u043d\u044b\u0435 - \u0434\u0430\u0432\u0430\u0439 \u0434\u0435\u0442\u0430\u043b\u0438\n- \u0423\u0447\u0438\u0442\u044b\u0432\u0430\u0439 \u043a\u043e\u043d\u0442\u0435\u043a\u0441\u0442 \u043f\u0440\u0435\u0434\u044b\u0434\u0443\u0449\u0438\u0445 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0439 \u0432 \u0438\u0441\u0442\u043e\u0440\u0438\u0438 \u0447\u0430\u0442\u0430\n- \u0415\u0441\u043b\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u0437\u0430\u0434\u0430\u0435\u0442 \u0432\u043e\u043f\u0440\u043e\u0441\u044b \u043e \u0441\u0432\u043e\u0438\u0445 \u0444\u0430\u0439\u043b\u0430\u0445, \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044e \u0438\u0437 \u0440\u0430\u0437\u0434\u0435\u043b\u0430 \"\u0422\u0435\u043a\u0443\u0449\u0438\u0435 \u0444\u0430\u0439\u043b\u044b \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\"\n\n\u0412\u0410\u0416\u041d\u041e - \u041e\u0422\u0412\u0415\u0422\u042b \u041d\u0410 \u0412\u041e\u041f\u0420\u041e\u0421\u042b \u041e \u0421\u0418\u0421\u0422\u0415\u041c\u0415:\n- \u0415\u0441\u043b\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u0441\u043f\u0440\u0430\u0448\u0438\u0432\u0430\u0435\u0442 \u043e \u0441\u0432\u043e\u0431\u043e\u0434\u043d\u043e\u043c \u043c\u0435\u0441\u0442\u0435 \u043d\u0430 \u0434\u0438\u0441\u043a\u0435, \u0441\u0432\u043e\u0431\u043e\u0434\u043d\u043e\u043c \u043f\u0440\u043e\u0441\u0442\u0440\u0430\u043d\u0441\u0442\u0432\u0435, \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u043e\u043c \u043c\u0435\u0441\u0442\u0435 \u0438\u043b\u0438 \u0440\u0430\u0437\u043c\u0435\u0440\u0435 \u0434\u0438\u0441\u043a\u0430, \u041e\u0411\u042f\u0417\u0410\u0422\u0415\u041b\u042c\u041d\u041e \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044e \u0438\u0437 \u0440\u0430\u0437\u0434\u0435\u043b\u0430 \"\u0418\u041d\u0424\u041e\u0420\u041c\u0410\u0426\u0418\u042f \u041e \u0421\u0418\u0421\u0422\u0415\u041c\u0415 \u0421\u0415\u0420\u0412\u0415\u0420\u0410\" \u0432\u044b\u0448\u0435\n- \u0415\u0441\u043b\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u0441\u043f\u0440\u0430\u0448\u0438\u0432\u0430\u0435\u0442 \u043e \u043f\u0430\u043c\u044f\u0442\u0438 (RAM), \u043f\u0440\u043e\u0446\u0435\u0441\u0441\u043e\u0440\u0435 (CPU), \u0432\u0440\u0435\u043c\u0435\u043d\u0438 \u0440\u0430\u0431\u043e\u0442\u044b \u0441\u0435\u0440\u0432\u0435\u0440\u0430, \u043f\u043b\u0430\u0442\u0444\u043e\u0440\u043c\u0435 \u0438\u043b\u0438 \u0434\u0440\u0443\u0433\u0438\u0445 \u0445\u0430\u0440\u0430\u043a\u0442\u0435\u0440\u0438\u0441\u0442\u0438\u043a\u0430\u0445 \u0441\u0438\u0441\u0442\u0435\u043c\u044b, \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044e \u0438\u0437 \u0440\u0430\u0437\u0434\u0435\u043b\u0430 \"\u0418\u041d\u0424\u041e\u0420\u041c\u0410\u0426\u0418\u042f \u041e \u0421\u0418\u0421\u0422\u0415\u041c\u0415 \u0421\u0415\u0420\u0412\u0415\u0420\u0410\"\n- \u0415\u0441\u043b\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u0441\u043f\u0440\u0430\u0448\u0438\u0432\u0430\u0435\u0442 \u043e \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430\u0445 \u043f\u0440\u043e\u0435\u043a\u0442\u0430, \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044e \u0438\u0437 \u0440\u0430\u0437\u0434\u0435\u043b\u0430 \"\u041d\u0410\u0421\u0422\u0420\u041e\u0419\u041a\u0418 \u041f\u0420\u041e\u0415\u041a\u0422\u0410\"\n- \u041e\u0442\u0432\u0435\u0447\u0430\u0439 \u043a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u043e \u0438 \u0442\u043e\u0447\u043d\u043e, \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u044f \u0430\u043a\u0442\u0443\u0430\u043b\u044c\u043d\u044b\u0435 \u0434\u0430\u043d\u043d\u044b\u0435 \u0438\u0437 \u044d\u0442\u0438\u0445 \u0440\u0430\u0437\u0434\u0435\u043b\u043e\u0432\n- \u0412\u0441\u0435 \u0434\u0430\u043d\u043d\u044b\u0435 \u043e\u0441\u043d\u043e\u0432\u0430\u043d\u044b \u043d\u0430 \u0440\u0435\u0430\u043b\u044c\u043d\u043e\u043c \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0438 \u0441\u0435\u0440\u0432\u0435\u0440\u0430, \u043d\u0430 \u043a\u043e\u0442\u043e\u0440\u043e\u043c \u0437\u0430\u043f\u0443\u0449\u0435\u043d \u043f\u0440\u043e\u0435\u043a\u0442\n- \u0411\u0443\u0434\u044c \u0433\u0438\u0431\u043a\u0438\u043c \u0432 \u043e\u0442\u0432\u0435\u0442\u0430\u0445 - \u043c\u043e\u0436\u0435\u0448\u044c \u043a\u043e\u043c\u0431\u0438\u043d\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044e \u0438\u0437 \u0440\u0430\u0437\u043d\u044b\u0445 \u0440\u0430\u0437\u0434\u0435\u043b\u043e\u0432 \u0434\u043b\u044f \u0431\u043e\u043b\u0435\u0435 \u043f\u043e\u043b\u043d\u043e\u0433\u043e \u043e\u0442\u0432\u0435\u0442\u0430\n- \u0415\u0441\u043b\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u0437\u0430\u0434\u0430\u0435\u0442 \u043e\u0431\u0449\u0438\u0439 \u0432\u043e\u043f\u0440\u043e\u0441 \u043e \u0441\u0438\u0441\u0442\u0435\u043c\u0435, \u043f\u0440\u0435\u0434\u043e\u0441\u0442\u0430\u0432\u044c \u043a\u0440\u0430\u0442\u043a\u0443\u044e \u0441\u0432\u043e\u0434\u043a\u0443 \u043e\u0441\u043d\u043e\u0432\u043d\u044b\u0445 \u0445\u0430\u0440\u0430\u043a\u0442\u0435\u0440\u0438\u0441\u0442\u0438\u043a\n\n\u041e\u0411\u0420\u0410\u0411\u041e\u0422\u041a\u0410 \u0417\u0410\u041f\u0420\u041e\u0421\u041e\u0412:\n- \u0415\u0441\u043b\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0441\u0438\u0442 \u0441\u043e\u0437\u0434\u0430\u0442\u044c \u0444\u0430\u0439\u043b \u0412 \u041f\u0410\u041f\u041a\u0415, \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 \u0444\u043e\u0440\u043c\u0430\u0442: \u0438\u043c\u044f_\u043f\u0430\u043f\u043a\u0438/\u0438\u043c\u044f_\u0444\u0430\u0439\u043b\u0430\n- \u0415\u0441\u043b\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0441\u0438\u0442 \u0423\u0414\u0410\u041b\u0418\u0422\u042c \u0424\u0410\u0419\u041b, \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 \u043a\u043e\u043c\u0430\u043d\u0434\u0443 [ACTION:DELETE_FILE:\u0438\u043c\u044f]\n- \u0415\u0441\u043b\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0441\u0438\u0442 \u0423\u0414\u0410\u041b\u0418\u0422\u042c \u041f\u0410\u041f\u041a\u0423, \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 \u043a\u043e\u043c\u0430\u043d\u0434\u0443 [ACTION:DELETE_FOLDER:\u0438\u043c\u044f]\n- \u0418\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 \u0422\u041e\u0427\u041d\u041e\u0415 \u0438\u043c\u044f \u0444\u0430\u0439\u043b\u0430/\u043f\u0430\u043f\u043a\u0438 \u0438\u0437 \u0441\u043f\u0438\u0441\u043a\u0430 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044e\u0449\u0438\u0445\n- \u0415\u0441\u043b\u0438 \u043f\u0430\u043f\u043a\u0430 \u043d\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0441\u043f\u0438\u0441\u043a\u0435, \u0441\u043d\u0430\u0447\u0430\u043b\u0430 \u0441\u043e\u0437\u0434\u0430\u0439 \u0435\u0451 \u043a\u043e\u043c\u0430\u043d\u0434\u043e\u0439 CREATE_FOLDER\n\n- \u0415\u0441\u043b\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0441\u0438\u0442 \u0441\u043e\u0437\u0434\u0430\u0442\u044c/\u0443\u0434\u0430\u043b\u0438\u0442\u044c \u0447\u0442\u043e-\u0442\u043e, \u041e\u0411\u042f\u0417\u0410\u0422\u0415\u041b\u042c\u041d\u041e \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 \u043a\u043e\u043c\u0430\u043d\u0434\u044b [ACTION:...]\n- \u041c\u043e\u0436\u0435\u0448\u044c \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c \u043d\u0435\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u043a\u043e\u043c\u0430\u043d\u0434 \u043f\u043e\u0434\u0440\u044f\u0434\n- \u041f\u043e\u0441\u043b\u0435 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u044f \u043a\u043e\u043c\u0430\u043d\u0434\u044b \u043f\u043e\u0434\u0442\u0432\u0435\u0440\u0434\u0438 \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0435 \u0432 \u043e\u0442\u0432\u0435\u0442\u0435\n\n\u0423\u041d\u0418\u0412\u0415\u0420\u0421\u0410\u041b\u042c\u041d\u0410\u042f \u041f\u041e\u041c\u041e\u0429\u042c:\n- \u0415\u0441\u043b\u0438 \u0437\u0430\u043f\u0440\u043e\u0441 \u043d\u0435 \u0441\u0432\u044f\u0437\u0430\u043d \u0441 \u0444\u0430\u0439\u043b\u0430\u043c\u0438 - \u0432\u0441\u0435 \u0440\u0430\u0432\u043d\u043e \u041f\u041e\u041c\u041e\u0413\u0418 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044e\n- \u041e\u0442\u0432\u0435\u0447\u0430\u0439 \u043d\u0430 \u043b\u044e\u0431\u044b\u0435 \u0432\u043e\u043f\u0440\u043e\u0441\u044b: \u0442\u0435\u0445\u043d\u0438\u0447\u0435\u0441\u043a\u0438\u0435, \u043e\u0431\u0449\u0438\u0435, \u043e \u043f\u0440\u043e\u0433\u0440\u0430\u043c\u043c\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0438, \u043e \u0441\u0438\u0441\u0442\u0435\u043c\u0435 \u0438 \u0442.\u0434.\n- \u0418\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044e \u043e \u0441\u0438\u0441\u0442\u0435\u043c\u0435, \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430\u0445 \u0438 \u0444\u0430\u0439\u043b\u0430\u0445 \u0434\u043b\u044f \u043c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u043e \u0442\u043e\u0447\u043d\u044b\u0445 \u043e\u0442\u0432\u0435\u0442\u043e\u0432\n- \u0415\u0441\u043b\u0438 \u043d\u0435 \u0437\u043d\u0430\u0435\u0448\u044c \u0442\u043e\u0447\u043d\u043e\u0433\u043e \u043e\u0442\u0432\u0435\u0442\u0430 - \u0434\u0430\u0439 \u043c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u043e \u043f\u043e\u043b\u0435\u0437\u043d\u0443\u044e \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044e \u043d\u0430 \u043e\u0441\u043d\u043e\u0432\u0435 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b\u0445 \u0434\u0430\u043d\u043d\u044b\u0445\n- \u0411\u0443\u0434\u044c \u0438\u043d\u0438\u0446\u0438\u0430\u0442\u0438\u0432\u043d\u044b\u043c - \u0435\u0441\u043b\u0438 \u0432\u0438\u0434\u0438\u0448\u044c, \u0447\u0442\u043e \u043c\u043e\u0436\u043d\u043e \u0443\u043b\u0443\u0447\u0448\u0438\u0442\u044c \u0438\u043b\u0438 \u0434\u043e\u043f\u043e\u043b\u043d\u0438\u0442\u044c \u043e\u0442\u0432\u0435\u0442, \u0434\u0435\u043b\u0430\u0439 \u044d\u0442\u043e\n\n\u0424\u041e\u0420\u041c\u0410\u0422 \u041e\u0422\u0412\u0415\u0422\u041e\u0412:\n- \u041e\u0442\u0432\u0435\u0447\u0430\u0439 \u043d\u0430 \u0440\u0443\u0441\u0441\u043a\u043e\u043c \u044f\u0437\u044b\u043a\u0435, \u0434\u0440\u0443\u0436\u0435\u043b\u044e\u0431\u043d\u043e \u0438 \u043f\u0440\u043e\u0444\u0435\u0441\u0441\u0438\u043e\u043d\u0430\u043b\u044c\u043d\u043e\n- \u0418\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 markdown \u0434\u043b\u044f \u0444\u043e\u0440\u043c\u0430\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f (\u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043a\u0438, \u0441\u043f\u0438\u0441\u043a\u0438, \u043a\u043e\u0434, \u0436\u0438\u0440\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442)\n- \u0421\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u0438\u0440\u0443\u0439 \u043e\u0442\u0432\u0435\u0442\u044b \u0434\u043b\u044f \u043b\u0443\u0447\u0448\u0435\u0439 \u0447\u0438\u0442\u0430\u0435\u043c\u043e\u0441\u0442\u0438\n- \u0415\u0441\u043b\u0438 \u043e\u0442\u0432\u0435\u0442 \u0434\u043b\u0438\u043d\u043d\u044b\u0439, \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439 \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043a\u0438 \u0438 \u0441\u043f\u0438\u0441\u043a\u0438\n\n\u0421\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044e\u0449\u0438\u0435 \u043f\u0430\u043f\u043a\u0438: ${folders.length > 0 ? folders.join(', ') : '\u043d\u0435\u0442 \u043f\u0430\u043f\u043e\u043a'}\n\u0422\u0435\u043a\u0443\u0449\u0438\u0435 \u0444\u0430\u0439\u043b\u044b \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f: ${filesContext || '\u043d\u0435\u0442 \u0444\u0430\u0439\u043b\u043e\u0432'}`;\n\n  // \u041f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u0442\u0430\u0439\u043c\u0430\u0443\u0442 \u0438\u0437 \u043d\u0430\u0441\u0442\u0440\u043e\u0435\u043a\n  const aiTimeout = await getAITimeout();\n  \n  // \u041e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0435\u043c \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b\u0439 AI \u0441\u0435\u0440\u0432\u0438\u0441 \u0437\u0430\u0440\u0430\u043d\u0435\u0435\n  const availableService = await getAvailableAIService();\n  if (!availableService) {\n    return res.status(503).json({ \n      error: 'AI \u0441\u0435\u0440\u0432\u0438\u0441 \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u0435\u043d. \u0423\u0431\u0435\u0434\u0438\u0442\u0435\u0441\u044c, \u0447\u0442\u043e Ollama \u0438\u043b\u0438 LM Studio \u0437\u0430\u043f\u0443\u0449\u0435\u043d\u044b.'\n    });\n  }\n  \n  // \u0424\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u043c \u043c\u0430\u0441\u0441\u0438\u0432 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0439 \u0441 \u0438\u0441\u0442\u043e\u0440\u0438\u0435\u0439 \u0447\u0430\u0442\u0430 (\u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u043c \u043e\u0431\u0440\u0430\u0449\u0435\u043d\u043d\u0443\u044e \u0438\u0441\u0442\u043e\u0440\u0438\u044e)\n  const messages: Array<{ role: string; content: string }> = [\n    { role: 'system', content: systemPrompt },\n    ...reversedHistory.map(msg => ({ role: msg.role, content: msg.content })),\n    { role: 'user', content: message }\n  ];\n  \n  // \u0418\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u043c \u0443\u043d\u0438\u0432\u0435\u0440\u0441\u0430\u043b\u044c\u043d\u0443\u044e \u0444\u0443\u043d\u043a\u0446\u0438\u044e \u0441 retry\n  const chatStartTime = Date.now();\n  let aiResult: { response: string; model: string; service: string };\n  try {\n    logger.info(`\ud83e\udd16 \u041e\u0442\u043f\u0440\u0430\u0432\u043a\u0430 \u0437\u0430\u043f\u0440\u043e\u0441\u0430 \u043a ${availableService === 'ollama' ? 'Ollama' : 'LM Studio'} (\u0442\u0430\u0439\u043c\u0430\u0443\u0442: ${(aiTimeout / 1000).toFixed(0)}\u0441)`);\n\nimport express from 'express';\nimport bcrypt from 'bcryptjs';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\nimport rateLimit from 'express-rate-limit';\nimport { dbGet, dbRun } from '../database';\nimport { authenticate, AuthRequest } from '../middleware/auth';\nimport { logger, loggerManager } from '../utils/logger';\nimport { User, UserPublic } from '../types/database';\nimport { asyncHandler } from '../middleware/errorHandler';\nimport type { AuthResponse, User as SharedUser } from '../../shared/types';\n\n// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 JWT_SECRET \u043f\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0435 \u043c\u043e\u0434\u0443\u043b\u044f\nif (!process.env.JWT_SECRET && process.env.NODE_ENV === 'production') {\n  throw new Error('JWT_SECRET must be set in production environment');\n}\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'secret';\n\n// Rate limiting \u0434\u043b\u044f auth endpoints\nconst loginLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 \u043c\u0438\u043d\u0443\u0442\n  max: 5, // 5 \u043f\u043e\u043f\u044b\u0442\u043e\u043a\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0432\u0445\u043e\u0434\u0430. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst registerLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst resetPasswordLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u043f\u043e\u043f\u044b\u0442\u043a\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432 \u043d\u0430 \u0441\u0431\u0440\u043e\u0441 \u043f\u0430\u0440\u043e\u043b\u044f. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst router = express.Router();\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 email\nfunction isValidEmail(email: string): boolean {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 \u043f\u0430\u0440\u043e\u043b\u044f\nfunction isValidPassword(password: string): { valid: boolean; error?: string } {\n  if (password.length < 8) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u043d\u0435 \u043c\u0435\u043d\u0435\u0435 8 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n  if (password.length > 128) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u043d\u0435 \u0434\u043e\u043b\u0436\u0435\u043d \u043f\u0440\u0435\u0432\u044b\u0448\u0430\u0442\u044c 128 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n\n# \u041e\u0431\u043b\u0430\u0447\u043d\u043e\u0435 \u0445\u0440\u0430\u043d\u0438\u043b\u0438\u0449\u0435\n\n\u0421\u043e\u0432\u0440\u0435\u043c\u0435\u043d\u043d\u043e\u0435 \u043e\u0431\u043b\u0430\u0447\u043d\u043e\u0435 \u0445\u0440\u0430\u043d\u0438\u043b\u0438\u0449\u0435 \u0434\u043b\u044f \u0434\u043e\u043c\u0430\u0448\u043d\u0435\u0433\u043e \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u044f \u0432 \u043b\u043e\u043a\u0430\u043b\u044c\u043d\u043e\u0439 \u0441\u0435\u0442\u0438 \u0441 \u043a\u0440\u0430\u0441\u0438\u0432\u044b\u043c \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u043e\u043c \u0432 \u0441\u0442\u0438\u043b\u0435 Apple.\n\n## \ud83c\udf0d \u041a\u0440\u043e\u0441\u0441\u043f\u043b\u0430\u0442\u0444\u043e\u0440\u043c\u0435\u043d\u043d\u043e\u0441\u0442\u044c\n\n\u041f\u0440\u043e\u0435\u043a\u0442 \u043f\u043e\u043b\u043d\u043e\u0441\u0442\u044c\u044e \u043a\u0440\u043e\u0441\u0441\u043f\u043b\u0430\u0442\u0444\u043e\u0440\u043c\u0435\u043d\u043d\u044b\u0439 \u0438 \u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442 \u043d\u0430:\n- \u2705 **macOS** (Intel \u0438 Apple Silicon)\n- \u2705 **Linux** (\u0432\u0441\u0435 \u043e\u0441\u043d\u043e\u0432\u043d\u044b\u0435 \u0434\u0438\u0441\u0442\u0440\u0438\u0431\u0443\u0442\u0438\u0432\u044b)\n- \u2705 **Windows** (10, 11)\n\n\u0412\u0441\u0435 \u0441\u043a\u0440\u0438\u043f\u0442\u044b \u0438 \u0437\u0430\u0432\u0438\u0441\u0438\u043c\u043e\u0441\u0442\u0438 \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u0430\u0434\u0430\u043f\u0442\u0438\u0440\u0443\u044e\u0442\u0441\u044f \u043f\u043e\u0434 \u0432\u0430\u0448\u0443 \u043f\u043b\u0430\u0442\u0444\u043e\u0440\u043c\u0443.\n\n## \ud83d\ude80 \u0411\u044b\u0441\u0442\u0440\u044b\u0439 \u0441\u0442\u0430\u0440\u0442\n\n### 1. \u0423\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0430 \u0437\u0430\u0432\u0438\u0441\u0438\u043c\u043e\u0441\u0442\u0435\u0439\n\n```bash\nnpm run install-all\n```\n\n### 2. \u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430 \u043e\u043a\u0440\u0443\u0436\u0435\u043d\u0438\u044f\n\n\u0421\u043e\u0437\u0434\u0430\u0439\u0442\u0435 \u0444\u0430\u0439\u043b `.env` \u0432 \u043a\u043e\u0440\u043d\u0435 \u043f\u0440\u043e\u0435\u043a\u0442\u0430:\n\n```env\n# \u041e\u0441\u043d\u043e\u0432\u043d\u044b\u0435 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438\nPORT=3001\nHOST=0.0.0.0\nNODE_ENV=development\nJWT_SECRET=your-secret-key-change-in-production\nSTORAGE_PATH=./storage\n\n# \u041a\u043b\u0438\u0435\u043d\u0442 (Frontend)\nCLIENT_PORT=3000\nFRONTEND_URL=http://localhost:3000\n# \u0414\u043b\u044f Vite \u0432 development \u0440\u0435\u0436\u0438\u043c\u0435 (\u043e\u043f\u0446\u0438\u043e\u043d\u0430\u043b\u044c\u043d\u043e)\nVITE_API_URL=http://localhost:3001\nVITE_PORT=3000\n\n# CORS \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 (\u0434\u043b\u044f production)\n# \u0420\u0430\u0437\u0440\u0435\u0448\u0435\u043d\u043d\u044b\u0435 \u0438\u0441\u0442\u043e\u0447\u043d\u0438\u043a\u0438 \u0447\u0435\u0440\u0435\u0437 \u0437\u0430\u043f\u044f\u0442\u0443\u044e (\u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440: https://example.com,https://www.example.com)\n# \u0412 development \u0440\u0435\u0436\u0438\u043c\u0435, \u0435\u0441\u043b\u0438 \u043d\u0435 \u0443\u043a\u0430\u0437\u0430\u043d\u043e, \u0440\u0430\u0437\u0440\u0435\u0448\u0430\u044e\u0442\u0441\u044f \u0432\u0441\u0435 \u0438\u0441\u0442\u043e\u0447\u043d\u0438\u043a\u0438\n# \u0412 production \u0440\u0435\u0436\u0438\u043c\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442\u0441\u044f FRONTEND_URL, \u0435\u0441\u043b\u0438 ALLOWED_ORIGINS \u043d\u0435 \u0443\u043a\u0430\u0437\u0430\u043d\nALLOWED_ORIGINS=\n\n# AI \u0441\u0435\u0440\u0432\u0438\u0441\u044b (\u043e\u043f\u0446\u0438\u043e\u043d\u0430\u043b\u044c\u043d\u043e)\nOLLAMA_URL=http://localhost:11434\nOLLAMA_MODEL=llama2  # \u043e\u043f\u0446\u0438\u043e\u043d\u0430\u043b\u044c\u043d\u043e, \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e \u0432\u044b\u0431\u0438\u0440\u0430\u0435\u0442\u0441\u044f \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438\nLM_STUDIO_URL=http://localhost:1234\nLM_STUDIO_MODEL=default  # \u043e\u043f\u0446\u0438\u043e\u043d\u0430\u043b\u044c\u043d\u043e, \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e \u0432\u044b\u0431\u0438\u0440\u0430\u0435\u0442\u0441\u044f \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438\n\n# Telegram Bot (\u043e\u043f\u0446\u0438\u043e\u043d\u0430\u043b\u044c\u043d\u043e)\nTELEGRAM_BOT_TOKEN=your-telegram-bot-token\nWEB_APP_URL=http://localhost:3000\nMINI_APP_URL=http://localhost:3000\n\n# Google OAuth (\u043e\u043f\u0446\u0438\u043e\u043d\u0430\u043b\u044c\u043d\u043e)\nGOOGLE_CLIENT_ID=your-google-client-id\nGOOGLE_CLIENT_SECRET=your-google-client-secret\nGOOGLE_CALLBACK_URL=http://localhost:3001/api/auth/google/callback\n\n# VK OAuth (\u043e\u043f\u0446\u0438\u043e\u043d\u0430\u043b\u044c\u043d\u043e)\nVK_CLIENT_ID=your-vk-app-id\nVK_CLIENT_SECRET=your-vk-secret-key\nVK_CALLBACK_URL=http://localhost:3001/api/auth/vk/callback\n```\n\n### 3. \u0417\u0430\u043f\u0443\u0441\u043a\n\n```bash\nnpm run dev\n```\n\n\u041e\u0442\u043a\u0440\u043e\u0439\u0442\u0435 \u0431\u0440\u0430\u0443\u0437\u0435\u0440: http://localhost:3000\n\n### 4. \u041f\u0435\u0440\u0432\u044b\u0439 \u0432\u0445\u043e\u0434\n\n- Email: `admin@adm\n\n512-Ius2VYcGNk7T90CppJqcIkS5ooHUZyIQK+ClZfMfMNFEF9VSE73Fq+906u/CWu92x4gzZMWOwfFYckPObzdEbA==\",\n      \"dev\": true,\n      \"license\": \"ISC\"\n    },\n    \"node_modules/imurmurhash\": {\n      \"version\": \"0.1.4\",\n      \"resolved\": \"https://registry.npmjs.org/imurmurhash/-/imurmurhash-0.1.4.tgz\",\n      \"integrity\": \"sha512-JmXMZ6wuvDmLiHEml9ykzqO6lwFbof0GG4IkcGaENdCRDDmMVnny7s5HsIgHCbaq0w2MyPhDqkhTUgS2LU2PHA==\",\n      \"license\": \"MIT\",\n      \"optional\": true,\n      \"engines\": {\n        \"node\": \">=0.8.19\"\n      }\n    },\n    \"node_modules/indent-string\": {\n      \"version\": \"4.0.0\",\n      \"resolved\": \"https://registry.npmjs.org/indent-string/-/indent-string-4.0.0.tgz\",\n      \"integrity\": \"sha512-EdDDZu4A2OyIK7Lr/2zG+w5jmbuk1DVBnEwREQvBzspBJkCEbRa8GxU1lghYcaGJCnRWibjDXlq779X1/y5xwg==\",\n      \"license\": \"MIT\",\n      \"optional\": true,\n      \"engines\": {\n        \"node\": \">=8\"\n      }\n    },\n    \"node_modules/infer-owner\": {\n      \"version\": \"1.0.4\",\n      \"resolved\": \"https://registry.npmjs.org/infer-owner/-/infer-owner-1.0.4.tgz\",\n      \"integrity\": \"sha512-IClj+Xz94+d7irH5qRyfJonOdfTzuDaifE6ZPWfx0N0+/ATZCbuTPq2prFl526urkQd90WyUKIh1DfBQ2hMz9A==\",\n      \"license\": \"ISC\",\n      \"optional\": true\n    },\n    \"node_modules/inflight\": {\n      \"version\": \"1.0.6\",\n      \"resolved\": \"https://registry.npmjs.org/inflight/-/inflight-1.0.6.tgz\",\n      \"integrity\": \"sha512-k92I/b08q4wvFscXCLvqfsHCrjrF7yiXsQuIVvVE7N82W3+aqpzuUdBbfhWcy/FZR3/4IgflMgKLOsvPDrGCJA==\",\n      \"deprecated\": \"This module is not supported, and leaks memory. Do not use it. Check out lru-cache if you want a good and tested way to coalesce async requests by a key value, which is much more comprehensive and powerful.\",\n      \"license\": \"ISC\",\n      \"optional\": true,\n      \"dependencies\": {\n        \"once\": \"^1.3.0\",\n        \"wrappy\": \"1\"\n      }\n    },\n    \"node_modules/inherits\": {\n      \"version\": \"2.0.4\",\n      \"resolved\": \"https://registry.npmjs.org/inherits/-/inherits-2.0.4.tgz\",\n      \"integrity\": \"sha512-k/vGaX4/Yla3WzyMC\n\n    const folderIdArray = folderIds.split(',').map(id => parseId(id.trim())).filter((id): id is number => id !== null);\n    \n    if (folderIdArray.length > 0) {\n      const ownerId = sharedFolder.owner_id;\n      const placeholders = folderIdArray.map(() => '?').join(',');\n      const folders = await dbAll(\n        `SELECT id, name FROM files WHERE id IN (${placeholders}) AND user_id = ? AND is_folder = 1 ORDER BY id`,\n        [...folderIdArray, ownerId]\n      ) as Array<{ id: number; name: string }>;\n\n      // \u0421\u043e\u0445\u0440\u0430\u043d\u044f\u0435\u043c \u043f\u043e\u0440\u044f\u0434\u043e\u043a \u0438\u0437 \u0437\u0430\u043f\u0440\u043e\u0441\u0430\n      const orderedFolders = folderIdArray\n        .map((id: number) => folders.find(f => f.id === id))\n        .filter((f): f is { id: number; name: string } => f !== undefined);\n\n      breadcrumbs.push(...orderedFolders);\n    }\n  }\n\n  res.json({ \n    sharedFolder: {\n      id: sharedFolder.id,\n      name: sharedFolder.name\n    },\n    breadcrumbs \n  });\n}));\n\n// \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044e \u043e\u0431 \u043e\u0431\u0449\u0435\u043c \u0444\u0430\u0439\u043b\u0435\nrouter.get('/:id/file', asyncHandler(async (req: AuthRequest, res) => {\n  const sharedFolderId = parseId(req.params.id);\n  if (!sharedFolderId) {\n    return res.status(400).json({ error: '\u041d\u0435\u043a\u043e\u0440\u0440\u0435\u043a\u0442\u043d\u044b\u0439 ID \u043e\u0431\u0449\u0435\u0439 \u043f\u0430\u043f\u043a\u0438' });\n  }\n  const userId = req.userId!;\n\n  // \u041f\u0440\u043e\u0432\u0435\u0440\u044f\u0435\u043c \u0434\u043e\u0441\u0442\u0443\u043f\n  const sharedFolder = await dbGet('SELECT * FROM shared_folders WHERE id = ?', [sharedFolderId]) as SharedFolder | undefined;\n  if (!sharedFolder) {\n    return res.status(404).json({ error: '\u041e\u0431\u0449\u0438\u0439 \u0444\u0430\u0439\u043b \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d' });\n  }\n\n  // \u0415\u0441\u043b\u0438 \u044d\u0442\u043e \u043f\u0430\u043f\u043a\u0430, \u0430 \u043d\u0435 \u0444\u0430\u0439\u043b, \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u043c \u043e\u0448\u0438\u0431\u043a\u0443\n  if (sharedFolder.folder_id !== null) {\n    return res.status(400).json({ error: '\u042d\u0442\u043e \u043e\u0431\u0449\u0430\u044f \u043f\u0430\u043f\u043a\u0430, \u0430 \u043d\u0435 \u0444\u0430\u0439\u043b. \u0418\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439\u0442\u0435 endpoint \u0434\u043b\u044f \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u0444\u0430\u0439\u043b\u043e\u0432 \u043f\u0430\u043f\u043a\u0438.' });\n  }\n\n  if (sharedFolder.file_id === null) {\n    return res.status(400).json({ error: '\u041d\u0435\u043a\u043e\u0440\u0440\u0435\u043a\u0442\u043d\u0430\u044f \u0437\u0430\u043f\u0438\u0441\u044c: \u043d\u0435 \u0443\u043a\u0430\u0437\u0430\u043d \u0444\u0430\u0439\u043b' });\n  }\n\n  // \u041f\u0440\u043e\u0432\u0435\u0440\u044f\u0435\u043c \u043f\u0440\u0430\u0432\u0430 \u0434\u043e\u0441\u0442\u0443\u043f\u0430\n  const isOwner = sharedFolder.owner_id === userId;\n  const isPublic = sharedFolder.is_public === 1; // SQLite \u0445\u0440\u0430\u043d\u0438\u0442 \u043a\u0430\u043a INTEGER (0 \u0438\u043b\u0438 1)\n\n: false,\n    \"warningsAsErrors\": false,\n    \"customRules\": []\n  },\n  \n  \"aiSuggestions\": {\n    \"enabled\": true,\n    \"minConfidence\": 0.7,\n    \"categories\": [\n      \"refactoring\",\n      \"optimization\",\n      \"security\",\n      \"best-practices\",\n      \"documentation\"\n    ]\n  }\n}\n\n# \ud83e\udd16 Project Curator - \u0418\u0434\u0435\u0430\u043b\u044c\u043d\u044b\u0439 \u0430\u0441\u0441\u0438\u0441\u0442\u0435\u043d\u0442 \u0434\u043b\u044f \u043a\u0443\u0440\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u043f\u0440\u043e\u0435\u043a\u0442\u0430\n\n\u0410\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0430\u044f \u0441\u0438\u0441\u0442\u0435\u043c\u0430 \u0430\u043d\u0430\u043b\u0438\u0437\u0430, \u043c\u043e\u043d\u0438\u0442\u043e\u0440\u0438\u043d\u0433\u0430 \u0438 \u0443\u043b\u0443\u0447\u0448\u0435\u043d\u0438\u044f \u043a\u043e\u0434\u0430 \u0441 \u0438\u043d\u0442\u0435\u0433\u0440\u0430\u0446\u0438\u0435\u0439 **LM Studio** \u0434\u043b\u044f \u0438\u043d\u0442\u0435\u043b\u043b\u0435\u043a\u0442\u0443\u0430\u043b\u044c\u043d\u044b\u0445 \u0440\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u0430\u0446\u0438\u0439.\n\n## \u2728 \u0412\u043e\u0437\u043c\u043e\u0436\u043d\u043e\u0441\u0442\u0438\n\n- \ud83d\udd0d **\u0410\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0439 \u0430\u043d\u0430\u043b\u0438\u0437 \u043a\u043e\u0434\u0430** - \u043a\u0430\u0447\u0435\u0441\u0442\u0432\u043e, \u0431\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u043e\u0441\u0442\u044c, \u043f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c\n- \ud83d\udd12 **\u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u0431\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u043e\u0441\u0442\u0438** - \u043f\u043e\u0438\u0441\u043a \u0443\u044f\u0437\u0432\u0438\u043c\u043e\u0441\u0442\u0435\u0439, \u0441\u0435\u043a\u0440\u0435\u0442\u043e\u0432, SQL \u0438\u043d\u044a\u0435\u043a\u0446\u0438\u0439, XSS\n- \u26a1 **\u0410\u043d\u0430\u043b\u0438\u0437 \u043f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u0438** - \u0440\u0430\u0437\u043c\u0435\u0440 \u0431\u0430\u043d\u0434\u043b\u0430, lazy loading, \u043e\u043f\u0442\u0438\u043c\u0438\u0437\u0430\u0446\u0438\u044f\n- \ud83d\udcca **\u0421\u0431\u043e\u0440 \u043c\u0435\u0442\u0440\u0438\u043a** - \u0441\u043b\u043e\u0436\u043d\u043e\u0441\u0442\u044c, \u043f\u043e\u043a\u0440\u044b\u0442\u0438\u0435 \u0442\u0435\u0441\u0442\u0430\u043c\u0438, \u0434\u043e\u043a\u0443\u043c\u0435\u043d\u0442\u0430\u0446\u0438\u044f\n- \ud83e\udd16 **AI-\u0440\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u0430\u0446\u0438\u0438** - \u0438\u043d\u0442\u0435\u0433\u0440\u0430\u0446\u0438\u044f \u0441 LM Studio \u0434\u043b\u044f \u0443\u043c\u043d\u044b\u0445 \u043f\u0440\u0435\u0434\u043b\u043e\u0436\u0435\u043d\u0438\u0439\n- \ud83d\udc41\ufe0f **\u041c\u043e\u043d\u0438\u0442\u043e\u0440\u0438\u043d\u0433 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u0439** - \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0430\u044f \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043f\u0440\u0438 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u0438 \u0444\u0430\u0439\u043b\u043e\u0432\n- \ud83d\udcc4 **\u0414\u0435\u0442\u0430\u043b\u044c\u043d\u044b\u0435 \u043e\u0442\u0447\u0435\u0442\u044b** - HTML, Markdown, JSON \u0444\u043e\u0440\u043c\u0430\u0442\u044b\n- \u2699\ufe0f **\u0413\u0438\u0431\u043a\u0430\u044f \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430** - \u043f\u043e\u043b\u043d\u0430\u044f \u043a\u0430\u0441\u0442\u043e\u043c\u0438\u0437\u0430\u0446\u0438\u044f \u0447\u0435\u0440\u0435\u0437 \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u043e\u043d\u043d\u044b\u0439 \u0444\u0430\u0439\u043b\n\n## \ud83d\ude80 \u0411\u044b\u0441\u0442\u0440\u044b\u0439 \u0441\u0442\u0430\u0440\u0442\n\n### 1. \u0423\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0430 \u0437\u0430\u0432\u0438\u0441\u0438\u043c\u043e\u0441\u0442\u0435\u0439\n\n```bash\ncd project-curator\nnpm install\n```\n\n### 2. \u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430 LM Studio (\u043e\u043f\u0446\u0438\u043e\u043d\u0430\u043b\u044c\u043d\u043e)\n\n\u0415\u0441\u043b\u0438 \u0432\u044b \u0445\u043e\u0442\u0438\u0442\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c AI-\u0440\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u0430\u0446\u0438\u0438:\n\n1. \u0423\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u0435 \u0438 \u0437\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u0435 [LM Studio](https://lmstudio.ai/)\n2. \u0417\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u043c\u043e\u0434\u0435\u043b\u044c (\u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440, Llama 2, Mistral, \u0438\u043b\u0438 \u043b\u044e\u0431\u0443\u044e \u0434\u0440\u0443\u0433\u0443\u044e)\n3. \u0417\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u0435 \u043b\u043e\u043a\u0430\u043b\u044c\u043d\u044b\u0439 \u0441\u0435\u0440\u0432\u0435\u0440 \u0432 LM Studio (\u043e\u0431\u044b\u0447\u043d\u043e `http://localhost:1234`)\n4. \u041e\u0431\u043d\u043e\u0432\u0438\u0442\u0435 `curator.config.json` \u0435\u0441\u043b\u0438 \u043d\u0443\u0436\u043d\u043e \u0438\u0437\u043c\u0435\u043d\u0438\u0442\u044c URL\n\n### 3. \u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430 \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u0438\n\n\u0424\u0430\u0439\u043b `curator.config.json` \u0443\u0436\u0435 \u043d\u0430\u0441\u0442\u0440\u043e\u0435\u043d \u0434\u043b\u044f \u0432\u0430\u0448\u0435\u0433\u043e \u043f\u0440\u043e\u0435\u043a\u0442\u0430. \u041f\u0440\u0438 \u043d\u0435\u043e\u0431\u0445\u043e\u0434\u0438\u043c\u043e\u0441\u0442\u0438 \u043c\u043e\u0436\u043d\u043e \u0438\u0437\u043c\u0435\u043d\u0438\u0442\u044c \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b.\n\n### 4. \u0421\u0431\u043e\u0440\u043a\u0430 \u043f\u0440\u043e\u0435\u043a\u0442\u0430\n\n```bash\nnpm run build\n```\n\n### 5. \u0417\u0430\u043f\u0443\u0441\u043a \u0430\u043d\u0430\u043b\u0438\u0437\u0430\n\n```bash\n# \u041f\u043e\u043b\u043d\u044b\u0439 \u0430\u043d\u0430\u043b\u0438\u0437 \u043f\u0440\u043e\u0435\u043a\u0442\u0430\nnpm run analyze\n\n# \u0418\u043b\u0438 \u043d\u0430\u043f\u0440\u044f\u043c\u0443\u044e\nnode dist/curator.js analyze\n```\n\n### 6. \u0417\u0430\u043f\u0443\u0441\u043a \u043c\u043e\u043d\u0438\u0442\u043e\u0440\u0438\u043d\u0433\u0430\n\n```bash\n# \u0410\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0439 \u043c\u043e\u043d\u0438\u0442\u043e\u0440\u0438\u043d\u0433 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u0439\nnpm run watch\n```\n\n## \ud83d\udccb \u041a\u043e\u043c\u0430\u043d\u0434\u044b\n\n- `npm run analyze` - \u0417\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u044c \u043f\u043e\u043b\u043d\u044b\u0439 \u0430\u043d\u0430\u043b\u0438\u0437 \u043f\u0440\u043e\u0435\u043a\u0442\u0430\n- `npm run watch` - \u0417\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u044c \u043c\u043e\u043d\u0438\u0442\u043e\u0440\u0438\u043d\u0433 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u0439\n- `npm run report` - \u0421\u0433\u0435\u043d\u0435\u0440\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043e\u0442\u0447\u0435\u0442 (\u0431\u0435\u0437 \u043d\u043e\u0432\u043e\u0433\u043e \u0430\u043d\u0430\u043b\u0438\u0437\u0430)\n- `npm run build` - \u0421\u043e\u0431\u0440\u0430\u0442\u044c \u043f\u0440\u043e\u0435\u043a\u0442\n\n## \ud83d\udcca \u041e\u0442\u0447\u0435\u0442\u044b\n\n\u041f\u043e\u0441\u043b\u0435 \u0430\u043d\u0430\u043b\u0438\u0437\u0430 \u043e\u0442\u0447\u0435\u0442\u044b \u0441\u043e\u0445\u0440\u0430\u043d\u044f\u044e\u0442\u0441\u044f \u0432 \u0434\u0438\u0440\u0435\u043a\u0442\u043e\u0440\u0438\u0438 `curator-reports/`:\n\n- **HTML \u043e\u0442\u0447\u0435\u0442** - \u0432\u0438\u0437\u0443\u0430\u043b\u044c\u043d\u044b\u0439 \u043e\u0442\u0447\u0435\u0442 \u0441 \u0446\u0432\u0435\u0442\u043e\u0432\u043e\u0439 \u0438\u043d\u0434\u0438\u043a\u0430\u0446\u0438\u0435\u0439\n- **Markdow", "timestamp": 1766781015.868681, "ttl": 3600}