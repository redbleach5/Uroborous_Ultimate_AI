{"value": "import express from 'express';\nimport bcrypt from 'bcryptjs';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\nimport rateLimit from 'express-rate-limit';\nimport { dbGet, dbRun } from '../database';\nimport { authenticate, AuthRequest } from '../middleware/auth';\nimport { logger, loggerManager } from '../utils/logger';\nimport { User, UserPublic } from '../types/database';\nimport { asyncHandler } from '../middleware/errorHandler';\nimport type { AuthResponse, User as SharedUser } from '../../shared/types';\n\n// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 JWT_SECRET \u043f\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0435 \u043c\u043e\u0434\u0443\u043b\u044f\nif (!process.env.JWT_SECRET && process.env.NODE_ENV === 'production') {\n  throw new Error('JWT_SECRET must be set in production environment');\n}\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'secret';\n\n// Rate limiting \u0434\u043b\u044f auth endpoints\nconst loginLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 \u043c\u0438\u043d\u0443\u0442\n  max: 5, // 5 \u043f\u043e\u043f\u044b\u0442\u043e\u043a\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0432\u0445\u043e\u0434\u0430. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst registerLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst resetPasswordLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u043f\u043e\u043f\u044b\u0442\u043a\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432 \u043d\u0430 \u0441\u0431\u0440\u043e\u0441 \u043f\u0430\u0440\u043e\u043b\u044f. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst router = express.Router();\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 email\nfunction isValidEmail(email: string): boolean {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 \u043f\u0430\u0440\u043e\u043b\u044f\nfunction isValidPassword(password: string): { valid: boolean; error?: string } {\n  if (password.length < 8) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u043d\u0435 \u043c\u0435\u043d\u0435\u0435 8 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n  if (password.length > 128) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u043d\u0435 \u0434\u043e\u043b\u0436\u0435\u043d \u043f\u0440\u0435\u0432\u044b\u0448\u0430\u0442\u044c 128 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n\nimport express from 'express';\nimport bcrypt from 'bcryptjs';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\nimport rateLimit from 'express-rate-limit';\nimport { dbGet, dbRun } from '../database';\nimport { authenticate, AuthRequest } from '../middleware/auth';\nimport { logger, loggerManager } from '../utils/logger';\nimport { User, UserPublic } from '../types/database';\nimport { asyncHandler } from '../middleware/errorHandler';\nimport type { AuthResponse, User as SharedUser } from '../../shared/types';\n\n// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 JWT_SECRET \u043f\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0435 \u043c\u043e\u0434\u0443\u043b\u044f\nif (!process.env.JWT_SECRET && process.env.NODE_ENV === 'production') {\n  throw new Error('JWT_SECRET must be set in production environment');\n}\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'secret';\n\n// Rate limiting \u0434\u043b\u044f auth endpoints\nconst loginLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 \u043c\u0438\u043d\u0443\u0442\n  max: 5, // 5 \u043f\u043e\u043f\u044b\u0442\u043e\u043a\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0432\u0445\u043e\u0434\u0430. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst registerLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst resetPasswordLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u043f\u043e\u043f\u044b\u0442\u043a\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432 \u043d\u0430 \u0441\u0431\u0440\u043e\u0441 \u043f\u0430\u0440\u043e\u043b\u044f. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst router = express.Router();\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 email\nfunction isValidEmail(email: string): boolean {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 \u043f\u0430\u0440\u043e\u043b\u044f\nfunction isValidPassword(password: string): { valid: boolean; error?: string } {\n  if (password.length < 8) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u043d\u0435 \u043c\u0435\u043d\u0435\u0435 8 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n  if (password.length > 128) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u043d\u0435 \u0434\u043e\u043b\u0436\u0435\u043d \u043f\u0440\u0435\u0432\u044b\u0448\u0430\u0442\u044c 128 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n\nimport express from 'express';\nimport bcrypt from 'bcryptjs';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\nimport rateLimit from 'express-rate-limit';\nimport { dbGet, dbRun } from '../database';\nimport { authenticate, AuthRequest } from '../middleware/auth';\nimport { logger, loggerManager } from '../utils/logger';\nimport { User, UserPublic } from '../types/database';\nimport { asyncHandler } from '../middleware/errorHandler';\nimport type { AuthResponse, User as SharedUser } from '../../shared/types';\n\n// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 JWT_SECRET \u043f\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0435 \u043c\u043e\u0434\u0443\u043b\u044f\nif (!process.env.JWT_SECRET && process.env.NODE_ENV === 'production') {\n  throw new Error('JWT_SECRET must be set in production environment');\n}\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'secret';\n\n// Rate limiting \u0434\u043b\u044f auth endpoints\nconst loginLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 \u043c\u0438\u043d\u0443\u0442\n  max: 5, // 5 \u043f\u043e\u043f\u044b\u0442\u043e\u043a\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0432\u0445\u043e\u0434\u0430. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst registerLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst resetPasswordLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u043f\u043e\u043f\u044b\u0442\u043a\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432 \u043d\u0430 \u0441\u0431\u0440\u043e\u0441 \u043f\u0430\u0440\u043e\u043b\u044f. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst router = express.Router();\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 email\nfunction isValidEmail(email: string): boolean {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 \u043f\u0430\u0440\u043e\u043b\u044f\nfunction isValidPassword(password: string): { valid: boolean; error?: string } {\n  if (password.length < 8) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u043d\u0435 \u043c\u0435\u043d\u0435\u0435 8 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n  if (password.length > 128) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u043d\u0435 \u0434\u043e\u043b\u0436\u0435\u043d \u043f\u0440\u0435\u0432\u044b\u0448\u0430\u0442\u044c 128 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n\nimport express from 'express';\nimport bcrypt from 'bcryptjs';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\nimport rateLimit from 'express-rate-limit';\nimport { dbGet, dbRun } from '../database';\nimport { authenticate, AuthRequest } from '../middleware/auth';\nimport { logger, loggerManager } from '../utils/logger';\nimport { User, UserPublic } from '../types/database';\nimport { asyncHandler } from '../middleware/errorHandler';\nimport type { AuthResponse, User as SharedUser } from '../../shared/types';\n\n// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 JWT_SECRET \u043f\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0435 \u043c\u043e\u0434\u0443\u043b\u044f\nif (!process.env.JWT_SECRET && process.env.NODE_ENV === 'production') {\n  throw new Error('JWT_SECRET must be set in production environment');\n}\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'secret';\n\n// Rate limiting \u0434\u043b\u044f auth endpoints\nconst loginLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 \u043c\u0438\u043d\u0443\u0442\n  max: 5, // 5 \u043f\u043e\u043f\u044b\u0442\u043e\u043a\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0432\u0445\u043e\u0434\u0430. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst registerLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst resetPasswordLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u043f\u043e\u043f\u044b\u0442\u043a\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432 \u043d\u0430 \u0441\u0431\u0440\u043e\u0441 \u043f\u0430\u0440\u043e\u043b\u044f. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst router = express.Router();\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 email\nfunction isValidEmail(email: string): boolean {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 \u043f\u0430\u0440\u043e\u043b\u044f\nfunction isValidPassword(password: string): { valid: boolean; error?: string } {\n  if (password.length < 8) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u043d\u0435 \u043c\u0435\u043d\u0435\u0435 8 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n  if (password.length > 128) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u043d\u0435 \u0434\u043e\u043b\u0436\u0435\u043d \u043f\u0440\u0435\u0432\u044b\u0448\u0430\u0442\u044c 128 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n\nimport express from 'express';\nimport bcrypt from 'bcryptjs';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\nimport rateLimit from 'express-rate-limit';\nimport { dbGet, dbRun } from '../database';\nimport { authenticate, AuthRequest } from '../middleware/auth';\nimport { logger, loggerManager } from '../utils/logger';\nimport { User, UserPublic } from '../types/database';\nimport { asyncHandler } from '../middleware/errorHandler';\nimport type { AuthResponse, User as SharedUser } from '../../shared/types';\n\n// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 JWT_SECRET \u043f\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0435 \u043c\u043e\u0434\u0443\u043b\u044f\nif (!process.env.JWT_SECRET && process.env.NODE_ENV === 'production') {\n  throw new Error('JWT_SECRET must be set in production environment');\n}\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'secret';\n\n// Rate limiting \u0434\u043b\u044f auth endpoints\nconst loginLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 \u043c\u0438\u043d\u0443\u0442\n  max: 5, // 5 \u043f\u043e\u043f\u044b\u0442\u043e\u043a\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0432\u0445\u043e\u0434\u0430. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst registerLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst resetPasswordLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u043f\u043e\u043f\u044b\u0442\u043a\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432 \u043d\u0430 \u0441\u0431\u0440\u043e\u0441 \u043f\u0430\u0440\u043e\u043b\u044f. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst router = express.Router();\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 email\nfunction isValidEmail(email: string): boolean {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 \u043f\u0430\u0440\u043e\u043b\u044f\nfunction isValidPassword(password: string): { valid: boolean; error?: string } {\n  if (password.length < 8) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u043d\u0435 \u043c\u0435\u043d\u0435\u0435 8 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n  if (password.length > 128) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u043d\u0435 \u0434\u043e\u043b\u0436\u0435\u043d \u043f\u0440\u0435\u0432\u044b\u0448\u0430\u0442\u044c 128 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n\nimport express from 'express';\nimport bcrypt from 'bcryptjs';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\nimport rateLimit from 'express-rate-limit';\nimport { dbGet, dbRun } from '../database';\nimport { authenticate, AuthRequest } from '../middleware/auth';\nimport { logger, loggerManager } from '../utils/logger';\nimport { User, UserPublic } from '../types/database';\nimport { asyncHandler } from '../middleware/errorHandler';\nimport type { AuthResponse, User as SharedUser } from '../../shared/types';\n\n// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 JWT_SECRET \u043f\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0435 \u043c\u043e\u0434\u0443\u043b\u044f\nif (!process.env.JWT_SECRET && process.env.NODE_ENV === 'production') {\n  throw new Error('JWT_SECRET must be set in production environment');\n}\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'secret';\n\n// Rate limiting \u0434\u043b\u044f auth endpoints\nconst loginLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 \u043c\u0438\u043d\u0443\u0442\n  max: 5, // 5 \u043f\u043e\u043f\u044b\u0442\u043e\u043a\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0432\u0445\u043e\u0434\u0430. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst registerLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst resetPasswordLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u043f\u043e\u043f\u044b\u0442\u043a\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432 \u043d\u0430 \u0441\u0431\u0440\u043e\u0441 \u043f\u0430\u0440\u043e\u043b\u044f. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst router = express.Router();\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 email\nfunction isValidEmail(email: string): boolean {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 \u043f\u0430\u0440\u043e\u043b\u044f\nfunction isValidPassword(password: string): { valid: boolean; error?: string } {\n  if (password.length < 8) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u043d\u0435 \u043c\u0435\u043d\u0435\u0435 8 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n  if (password.length > 128) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u043d\u0435 \u0434\u043e\u043b\u0436\u0435\u043d \u043f\u0440\u0435\u0432\u044b\u0448\u0430\u0442\u044c 128 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n\nimport express from 'express';\nimport bcrypt from 'bcryptjs';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\nimport rateLimit from 'express-rate-limit';\nimport { dbGet, dbRun } from '../database';\nimport { authenticate, AuthRequest } from '../middleware/auth';\nimport { logger, loggerManager } from '../utils/logger';\nimport { User, UserPublic } from '../types/database';\nimport { asyncHandler } from '../middleware/errorHandler';\nimport type { AuthResponse, User as SharedUser } from '../../shared/types';\n\n// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 JWT_SECRET \u043f\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0435 \u043c\u043e\u0434\u0443\u043b\u044f\nif (!process.env.JWT_SECRET && process.env.NODE_ENV === 'production') {\n  throw new Error('JWT_SECRET must be set in production environment');\n}\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'secret';\n\n// Rate limiting \u0434\u043b\u044f auth endpoints\nconst loginLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 \u043c\u0438\u043d\u0443\u0442\n  max: 5, // 5 \u043f\u043e\u043f\u044b\u0442\u043e\u043a\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0432\u0445\u043e\u0434\u0430. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst registerLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst resetPasswordLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u043f\u043e\u043f\u044b\u0442\u043a\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432 \u043d\u0430 \u0441\u0431\u0440\u043e\u0441 \u043f\u0430\u0440\u043e\u043b\u044f. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst router = express.Router();\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 email\nfunction isValidEmail(email: string): boolean {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 \u043f\u0430\u0440\u043e\u043b\u044f\nfunction isValidPassword(password: string): { valid: boolean; error?: string } {\n  if (password.length < 8) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u043d\u0435 \u043c\u0435\u043d\u0435\u0435 8 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n  if (password.length > 128) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u043d\u0435 \u0434\u043e\u043b\u0436\u0435\u043d \u043f\u0440\u0435\u0432\u044b\u0448\u0430\u0442\u044c 128 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n\nimport express from 'express';\nimport bcrypt from 'bcryptjs';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\nimport rateLimit from 'express-rate-limit';\nimport { dbGet, dbRun } from '../database';\nimport { authenticate, AuthRequest } from '../middleware/auth';\nimport { logger, loggerManager } from '../utils/logger';\nimport { User, UserPublic } from '../types/database';\nimport { asyncHandler } from '../middleware/errorHandler';\nimport type { AuthResponse, User as SharedUser } from '../../shared/types';\n\n// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 JWT_SECRET \u043f\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0435 \u043c\u043e\u0434\u0443\u043b\u044f\nif (!process.env.JWT_SECRET && process.env.NODE_ENV === 'production') {\n  throw new Error('JWT_SECRET must be set in production environment');\n}\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'secret';\n\n// Rate limiting \u0434\u043b\u044f auth endpoints\nconst loginLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 \u043c\u0438\u043d\u0443\u0442\n  max: 5, // 5 \u043f\u043e\u043f\u044b\u0442\u043e\u043a\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0432\u0445\u043e\u0434\u0430. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst registerLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst resetPasswordLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u043f\u043e\u043f\u044b\u0442\u043a\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432 \u043d\u0430 \u0441\u0431\u0440\u043e\u0441 \u043f\u0430\u0440\u043e\u043b\u044f. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst router = express.Router();\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 email\nfunction isValidEmail(email: string): boolean {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 \u043f\u0430\u0440\u043e\u043b\u044f\nfunction isValidPassword(password: string): { valid: boolean; error?: string } {\n  if (password.length < 8) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u043d\u0435 \u043c\u0435\u043d\u0435\u0435 8 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n  if (password.length > 128) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u043d\u0435 \u0434\u043e\u043b\u0436\u0435\u043d \u043f\u0440\u0435\u0432\u044b\u0448\u0430\u0442\u044c 128 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n\nimport express from 'express';\nimport bcrypt from 'bcryptjs';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\nimport rateLimit from 'express-rate-limit';\nimport { dbGet, dbRun } from '../database';\nimport { authenticate, AuthRequest } from '../middleware/auth';\nimport { logger, loggerManager } from '../utils/logger';\nimport { User, UserPublic } from '../types/database';\nimport { asyncHandler } from '../middleware/errorHandler';\nimport type { AuthResponse, User as SharedUser } from '../../shared/types';\n\n// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 JWT_SECRET \u043f\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0435 \u043c\u043e\u0434\u0443\u043b\u044f\nif (!process.env.JWT_SECRET && process.env.NODE_ENV === 'production') {\n  throw new Error('JWT_SECRET must be set in production environment');\n}\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'secret';\n\n// Rate limiting \u0434\u043b\u044f auth endpoints\nconst loginLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 \u043c\u0438\u043d\u0443\u0442\n  max: 5, // 5 \u043f\u043e\u043f\u044b\u0442\u043e\u043a\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0432\u0445\u043e\u0434\u0430. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst registerLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst resetPasswordLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u043f\u043e\u043f\u044b\u0442\u043a\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432 \u043d\u0430 \u0441\u0431\u0440\u043e\u0441 \u043f\u0430\u0440\u043e\u043b\u044f. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst router = express.Router();\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 email\nfunction isValidEmail(email: string): boolean {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 \u043f\u0430\u0440\u043e\u043b\u044f\nfunction isValidPassword(password: string): { valid: boolean; error?: string } {\n  if (password.length < 8) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u043d\u0435 \u043c\u0435\u043d\u0435\u0435 8 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n  if (password.length > 128) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u043d\u0435 \u0434\u043e\u043b\u0436\u0435\u043d \u043f\u0440\u0435\u0432\u044b\u0448\u0430\u0442\u044c 128 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n\nimport express from 'express';\nimport bcrypt from 'bcryptjs';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\nimport rateLimit from 'express-rate-limit';\nimport { dbGet, dbRun } from '../database';\nimport { authenticate, AuthRequest } from '../middleware/auth';\nimport { logger, loggerManager } from '../utils/logger';\nimport { User, UserPublic } from '../types/database';\nimport { asyncHandler } from '../middleware/errorHandler';\nimport type { AuthResponse, User as SharedUser } from '../../shared/types';\n\n// \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 JWT_SECRET \u043f\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0435 \u043c\u043e\u0434\u0443\u043b\u044f\nif (!process.env.JWT_SECRET && process.env.NODE_ENV === 'production') {\n  throw new Error('JWT_SECRET must be set in production environment');\n}\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'secret';\n\n// Rate limiting \u0434\u043b\u044f auth endpoints\nconst loginLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 \u043c\u0438\u043d\u0443\u0442\n  max: 5, // 5 \u043f\u043e\u043f\u044b\u0442\u043e\u043a\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0432\u0445\u043e\u0434\u0430. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst registerLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u043f\u043e\u043f\u044b\u0442\u043e\u043a \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst resetPasswordLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 \u0447\u0430\u0441\n  max: 3, // 3 \u043f\u043e\u043f\u044b\u0442\u043a\u0438\n  message: '\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u043c\u043d\u043e\u0433\u043e \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432 \u043d\u0430 \u0441\u0431\u0440\u043e\u0441 \u043f\u0430\u0440\u043e\u043b\u044f. \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u043f\u043e\u0437\u0436\u0435.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst router = express.Router();\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 email\nfunction isValidEmail(email: string): boolean {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\n// \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u0438 \u043f\u0430\u0440\u043e\u043b\u044f\nfunction isValidPassword(password: string): { valid: boolean; error?: string } {\n  if (password.length < 8) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u043d\u0435 \u043c\u0435\u043d\u0435\u0435 8 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }\n  if (password.length > 128) {\n    return { valid: false, error: '\u041f\u0430\u0440\u043e\u043b\u044c \u043d\u0435 \u0434\u043e\u043b\u0436\u0435\u043d \u043f\u0440\u0435\u0432\u044b\u0448\u0430\u0442\u044c 128 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432' };\n  }", "timestamp": 1767035845.643744, "ttl": 3600}