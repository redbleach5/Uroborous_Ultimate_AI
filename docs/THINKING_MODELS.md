# Адаптация проекта под думающие модели (Thinking Models)

## Обзор изменений

Проект был адаптирован и оптимизирован для работы с думающими моделями (thinking models), которые поддерживают расширенное рассуждение и внутренний процесс мышления. Основные изменения включают:

1. **Поддержка thinking mode в LLM провайдерах**
2. **Оптимизация промптов для глубокого мышления**
3. **Автоматическое использование thinking mode для сложных задач**
4. **Конфигурация thinking mode на уровне агентов**

## Изменения в архитектуре

### 1. Базовые классы LLM (`backend/llm/base.py`)

- Добавлено поле `thinking` в `LLMResponse` для хранения reasoning trace
- Добавлено поле `has_thinking` для индикации наличия thinking content
- Добавлен параметр `thinking_mode` в методы `generate()` и `stream()`

### 2. Anthropic провайдер (`backend/llm/anthropic_provider.py`)

- Реализована поддержка thinking mode для моделей Claude 3.5 Sonnet и новее
- Автоматическое определение поддержки thinking mode по модели
- Извлечение thinking content из ответа API
- Поддержка thinking budget tokens для контроля ресурсов

**Поддерживаемые модели:**
- `claude-3-5-opus-20241022`
- `claude-3-5-sonnet-20241022`
- `claude-3-5-sonnet-20240620`
- `claude-3-opus-20240229`

### 3. Ollama провайдер (`backend/llm/ollama_provider.py`)

- **Нативная поддержка thinking mode** для моделей с встроенной поддержкой:
  - Llama 3.3 и новее
  - Qwen 2.5
  - DeepSeek модели
- **Эмуляция thinking mode** для моделей без нативной поддержки через оптимизированные промпты
- Автоматическое определение поддержки thinking mode по модели
- Извлечение thinking traces из структурированных ответов или текста

### 4. Другие провайдеры

- OpenAI провайдер обновлен для поддержки параметра `thinking_mode` (игнорируется, если не поддерживается)

### 4. BaseAgent (`backend/agents/base.py`)

- Добавлена конфигурация `use_thinking_mode` в конфиг агента
- Метод `_get_llm_response()` поддерживает параметр `use_thinking` для переопределения
- Автоматическое логирование thinking traces

### 5. ReactAgent (`backend/agents/react.py`)

- Оптимизирован системный промпт для поощрения глубокого мышления
- Автоматическое включение thinking mode для сложных задач
- Улучшенные инструкции по step-by-step reasoning

### 6. CodeWriterAgent (`backend/agents/code_writer.py`)

- Расширен системный промпт с секцией "THINKING PROCESS"
- Добавлены инструкции по глубокому анализу перед написанием кода
- Улучшены guidelines для архитектурного мышления

### 7. Orchestrator (`backend/orchestrator.py`)

- Thinking mode включен для task decomposition (сложное планирование)
- Thinking mode включен для agent selection (интеллектуальный выбор)
- Оптимизированы промпты для глубокого анализа задач

### 8. Конфигурация (`backend/config.py`)

- Добавлено поле `use_thinking_mode` в `AgentConfig`
- По умолчанию включено для:
  - `react` agent (сложное рассуждение)
  - `research` agent (исследовательские задачи)
  - `data_analysis` agent (анализ данных)

## Использование

### Включение thinking mode для агента

В конфигурационном файле (`config.yaml`):

```yaml
agents:
  react:
    enabled: true
    use_thinking_mode: true  # Включить thinking mode
    temperature: 0.5
    max_iterations: 20
```

### Программное использование

```python
# В коде агента
response = await self._get_llm_response(
    messages=messages,
    use_thinking=True  # Явно включить thinking mode
)
```

### Автоматическое определение

Агенты автоматически включают thinking mode для:
- Сложных задач (длина > 100 символов)
- Задач с ключевыми словами: "complex", "analyze", "plan", "design", "optimize"
- Задач планирования и декомпозиции в Orchestrator

## Преимущества

1. **Глубокое рассуждение**: Модели могут использовать расширенное внутреннее мышление для сложных задач
2. **Лучшее планирование**: Thinking mode улучшает качество декомпозиции задач
3. **Точный выбор агентов**: Более точный выбор агента благодаря глубокому анализу
4. **Качественный код**: Улучшенная генерация кода благодаря архитектурному мышлению
5. **Прозрачность**: Thinking traces доступны для анализа и отладки

## Ограничения

- Thinking mode доступен только для поддерживаемых моделей (Claude 3.5+)
- Увеличивает время ответа и потребление токенов
- Требует больше вычислительных ресурсов

## Рекомендации

1. **Используйте thinking mode для:**
   - Сложных задач планирования
   - Архитектурных решений
   - Многошагового рассуждения
   - Анализа и исследования

2. **Не используйте thinking mode для:**
   - Простых задач
   - Быстрых ответов
   - Задач с жесткими ограничениями по времени

3. **Настройка thinking budget:**
   - По умолчанию: 4096 токенов
   - Для очень сложных задач: увеличьте до 8192+
   - Для простых задач: уменьшите до 2048

## Будущие улучшения

- Поддержка thinking mode для других провайдеров (когда станет доступно)
- Адаптивный выбор thinking mode на основе сложности задачи
- Метрики и аналитика использования thinking mode
- Оптимизация thinking budget на основе истории задач

